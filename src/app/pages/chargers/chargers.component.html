<app-menu></app-menu>

<section class="page">
  <h1>Pedidos</h1>
  <p>
    GestiÃ³n de pedidos contra
    <code>http://localhost:8080/api/orders</code>.
  </p>

  <!-- ðŸ”„ TOOLBAR: TODOS / HOY / FUERA DE HORARIO -->
  <div class="toolbar">
    <button
      type="button"
      (click)="loadAll()"
      [disabled]="isLoading()"
    >
      Todos
    </button>

    <button
      type="button"
      (click)="loadToday()"
      [disabled]="isLoading()"
    >
      SÃ³lo hoy
    </button>

    <button
      type="button"
      (click)="loadOutside()"
      [disabled]="isLoading()"
    >
      Fuera de horario
    </button>
  </div>

  <!-- ðŸ”¹ FORMULARIO CREAR / EDITAR -->
  <form class="card" [formGroup]="orderForm" (ngSubmit)="submit()">
    <h2>
      {{ editingId() === null ? 'Nuevo pedido' : 'Editar pedido #' + editingId() }}
    </h2>

    <div class="fields">
<label>
  Id cliente
  <select formControlName="idCustomer">
    <option value="">-- Selecciona cliente --</option>
    <option *ngFor="let customer of customers()" [value]="customer.idCustomer">
      {{ customer.idCustomer }} Â· {{ customer.name }} Â· {{ customer.phoneNumber || 'Sin telÃ©fono' }}
    </option>
  </select>
</label>

      <label>
        Fecha (opcional)
        <input type="datetime-local" formControlName="date" />
      </label>

      <!-- ðŸ”¹ PIZZA -->
      <select
        formControlName="pizzaId"
        (change)="onPizzaChange($event)"
      >
        <option [ngValue]="null">-- Selecciona una pizza --</option>
        <option *ngFor="let pizza of pizzas()" [ngValue]="pizza.idPizza">
          {{ pizza.name }} Â·
          {{ pizza.price | number: '1.2-2' }} Bs
          ({{ pizza.vegetarian ? 'Vegetariana' : 'Normal' }})
        </option>
      </select>

      <!-- ðŸ”¹ CANTIDAD -->
      <label>
        Cantidad
        <input
          type="number"
          min="1"
          formControlName="pizzaQuantity"
          (input)="onQuantityOrPriceChange()"
        />
      </label>

      <!-- ðŸ”¹ PRECIO UNITARIO -->
      <label>
        Precio unitario (Bs)
        <input
          type="number"
          step="0.01"
          formControlName="pizzaPrice"
          (input)="onQuantityOrPriceChange()"
        />
      </label>

      <!-- ðŸ”¹ TOTAL (CALCULADO) -->
      <label>
        Total (Bs)
        <input
          type="number"
          formControlName="total"
          step="0.01"
          readonly
        />
      </label>

      <!-- ðŸ”¹ MÃ‰TODO -->
      <label>
        MÃ©todo
        <select formControlName="method">
          <option value="">-- Selecciona mÃ©todo --</option>
          <option value="D">Delivery</option>
          <option value="C">Para llevar</option>
          <option value="S">En el local</option>
        </select>
      </label>

      <label>
        Notas adicionales
        <textarea formControlName="additionalNotes" rows="2"></textarea>
      </label>
    </div>

    <div class="buttons">
      <button
        type="submit"
        [disabled]="orderForm.invalid || isSubmitting()"
      >
        {{ editingId() === null ? 'Crear pedido' : 'Guardar cambios' }}
      </button>

      <button
        type="button"
        (click)="clearForm()"
        [disabled]="isSubmitting()"
      >
        Limpiar
      </button>
    </div>
  </form>

  <!-- ðŸ’¬ FEEDBACK -->
  <p class="feedback" *ngIf="feedback()">
    {{ feedback() }}
  </p>

  <!-- â³ ESTADO DE CARGA -->
  <p *ngIf="isLoading()">
    Cargando pedidos...
  </p>

  <!-- ðŸ“‹ LISTA DE PEDIDOS -->
  <ul
    class="list"
    *ngIf="!isLoading() && orders().length > 0"
  >
    <li *ngFor="let order of orders(); trackBy: trackByOrder">
      <div class="row-main">
        <span class="main-info">
          Pedido #{{ order.idOrder }}
          Â· Cliente: {{ order.idCustomer }}
          Â· Tel: {{ customerPhones()[order.idCustomer] || 'â€”' }}
        </span>
        <span class="extra">
          Fecha: {{ order.date }} Â·
          Total: {{ order.total | number: '1.2-2' }} Bs Â·
          MÃ©todo: {{ order.method }}
        </span>
        <span class="extra">
          Notas:
          {{ order.additionalNotes || 'â€”' }}
        </span>
        <span class="extra">
          Pizzas:
          <ng-container *ngIf="order.items?.length; else noPizzas">
            <ng-container *ngFor="let item of order.items; let last = last">
              {{ item.quantity }}x
              {{ item.pizza?.name || ('Pizza #' + item.idPizza) }}
              <span *ngIf="item.pizza?.vegetarian">
                (Vegetariana)
              </span>{{ last ? '' : ', ' }}
            </ng-container>
          </ng-container>
          <ng-template #noPizzas>â€”</ng-template>
        </span>
      </div>

      <div class="row-actions">
        <button type="button" (click)="edit(order)">
          Editar
        </button>
        <button type="button" (click)="delete(order.idOrder)">
          Eliminar
        </button>
      </div>
    </li>
  </ul>

  <!-- ðŸ’¤ SIN DATOS -->
  <p *ngIf="!isLoading() && orders().length === 0">
    No hay pedidos registrados.
  </p>
</section>
